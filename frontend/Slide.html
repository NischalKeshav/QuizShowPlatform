

<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>Quiz Slides (Player)</title>
	<link rel="stylesheet" href="style.css" />
	<style>
		.slide-question { font-size:1.2rem; margin: 1rem 0; }
		.choices { display:flex; flex-direction:column; gap:0.6rem; margin-bottom:0.8rem; }
		.choice { padding:0.8rem; border-radius:0.6rem; background:#0f1025; cursor:pointer; border:1px solid rgba(255,255,255,0.03); }
		.choice.selected { outline:2px solid var(--primary); }
		.meta { display:flex; justify-content:space-between; align-items:center; gap:12px; }
		#timer { font-weight:700; }
		#reveal { margin-top:0.8rem; }
		#leaderboard { text-align:left; margin-top:0.8rem; }
		.small { font-size:0.9rem; color:var(--muted); }
	</style>
</head>
<body>
	<div class="card" style="max-width:760px;">
		<div class="logo">Quiz Whiz</div>
		<h1>Live Quiz (Player)</h1>

		<div class="meta">
			<div>Code: <span id="token">—</span></div>
			<div>Slide <span id="currentIdx">0</span>/<span id="totalSlides">0</span></div>
			<div>Time: <span id="timer">0</span>s</div>
		</div>

		<!-- Player name input removed; clicking a choice will prompt for name if needed -->

		<div id="slideArea" style="margin-top:10px">
			<div class="slide-question" id="question">No slide loaded.</div>
			<div class="choices" id="choices"></div>
			<div id="reveal"></div>
		</div>

		<div id="leaderboard"></div>

		<!-- Host controls removed from player view -->

		<hr style="margin:12px 0; opacity:0.06" />

		<!-- Simulation controls removed -->

	</div>

	<script>
		// run after DOM loaded
		window.addEventListener('DOMContentLoaded', () => {
			try {
				// Config
				const MAX_SLIDES = 20;
				const DEFAULT_SLIDE_DURATION = 15; // seconds per question
				const MAX_TIME_LIMIT = 60; // cap
				const slideDuration = Math.min(DEFAULT_SLIDE_DURATION, MAX_TIME_LIMIT);

				// Slides (4 questions)
				const slides = [
					{ q: 'What is 2 + 2?', choices: ['3','4','5','22'], correct: 1 },
					{ q: 'Which color mixes with blue to make green?', choices: ['Red','Yellow','Black','White'], correct: 1 },
					{ q: 'Capital of France?', choices: ['Berlin','Madrid','Paris','Rome'], correct: 2 },
					{ q: 'Which planet is known as the Red Planet?', choices: ['Earth','Venus','Mars','Jupiter'], correct: 2 }
				];

				// state
				let slideIndex = 0;
				let timerInterval = null;
				let started = false;

				// token from host/session
				const token = sessionStorage.getItem('hostToken') || localStorage.getItem('lastHostToken') || 'local-demo';
				document.getElementById('token').textContent = token;
				document.getElementById('totalSlides').textContent = Math.min(slides.length, MAX_SLIDES);

				// storage keys
				const answersKey = (idx) => `answers_${token}_${idx}`;
				const scoresKey = () => `scores_${token}`;

				function loadAnswers(idx) { try { return JSON.parse(localStorage.getItem(answersKey(idx))) || {}; } catch(e){ return {}; } }
				function saveAnswers(idx, obj) { localStorage.setItem(answersKey(idx), JSON.stringify(obj)); }
				function loadScores() { try { return JSON.parse(localStorage.getItem(scoresKey())) || {}; } catch(e){ return {}; } }
				function saveScores(s) { localStorage.setItem(scoresKey(), JSON.stringify(s)); }

				function renderLeaderboard() {
					const scores = loadScores();
					const list = Object.keys(scores).map(n => ({ n, s: scores[n] })).sort((a,b)=>b.s-a.s);
					const el = document.getElementById('leaderboard');
					if (!el) return;
					if (list.length === 0) { el.innerHTML = '<div class="small">No scores yet.</div>'; return; }
					el.innerHTML = '<strong>Leaderboard</strong><ol>' + list.map(it=>`<li>${it.n} — ${it.s}</li>`).join('') + '</ol>';
				}

				function renderSlide(idx) {
					const s = slides[idx];
					document.getElementById('currentIdx').textContent = idx+1;
					const qEl = document.getElementById('question'); if (qEl) qEl.textContent = s.q;
					const choices = document.getElementById('choices'); if (!choices) return;
					choices.innerHTML = '';
					s.choices.forEach((c, i) => {
						const btn = document.createElement('div');
						btn.className = 'choice';
						btn.textContent = c;
						btn.dataset.idx = i;
						btn.addEventListener('click', () => {
							// prompt for name if not stored, then submit
							let pname = sessionStorage.getItem('playerName');
							if (!pname) {
								pname = prompt('Enter your name to submit this answer') || `Player-${Date.now()}`;
								sessionStorage.setItem('playerName', pname);
							}
							const ans = loadAnswers(slideIndex);
							ans[pname] = i;
							saveAnswers(slideIndex, ans);
							// notify other tabs
							localStorage.setItem(`players_answered_${token}_${slideIndex}`, Date.now());
							const reveal = document.getElementById('reveal');
							if (reveal) reveal.innerHTML = `<div class="small">Answer submitted as <strong>${pname}</strong></div>`;
							// local highlight
							document.querySelectorAll('.choice').forEach(el=>el.classList.remove('selected'));
							btn.classList.add('selected');
						});
						choices.appendChild(btn);
					});

					const reveal = document.getElementById('reveal'); if (reveal) reveal.innerHTML = '';

					// update simulate select
					const simSel = document.getElementById('simChoice');
					if (simSel) { simSel.innerHTML = ''; s.choices.forEach((c,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=c; simSel.appendChild(o); }); }
				}

				function startTimer(sec, onTick, onEnd) {
					let t = sec;
					const timerEl = document.getElementById('timer'); if (timerEl) timerEl.textContent = t;
					timerInterval && clearInterval(timerInterval);
					timerInterval = setInterval(()=>{
						t -= 1;
						if (timerEl) timerEl.textContent = t;
						onTick && onTick(t);
						if (t <= 0) { clearInterval(timerInterval); timerInterval = null; onEnd && onEnd(); }
					}, 1000);
				}

				function revealAnswers(idx) {
					const s = slides[idx];
					const answers = loadAnswers(idx);
					const correctIdx = s.correct;
					const correctNames = Object.keys(answers).filter(n => Number(answers[n]) === correctIdx);

					// update scores
					const scores = loadScores();
					correctNames.forEach(n => { scores[n] = (scores[n]||0) + 1; });
					saveScores(scores);

					const reveal = document.getElementById('reveal');
					if (reveal) reveal.innerHTML = `<div>Correct answer: <strong>${s.choices[correctIdx]}</strong></div>
						<div style="margin-top:6px">Correct: ${correctNames.length ? correctNames.join(', ') : 'None'}</div>`;

					renderLeaderboard();
				}

				async function runSlide(idx) {
					renderSlide(idx);
					// clear stored answers for this slide so only fresh answers count
					saveAnswers(idx, {});
					// start timer
					await new Promise((res) => startTimer(slideDuration, null, res));
					// reveal
					revealAnswers(idx);
					// pause before next
					await new Promise(r => setTimeout(r, 4000));
				}

				async function startQuiz() {
					if (started) return; started = true;
					const startBtn = document.getElementById('startBtn'); if (startBtn) startBtn.disabled = true;
					const nextBtn = document.getElementById('nextBtn'); if (nextBtn) nextBtn.style.display = 'inline-block';
					for (let i=0;i<Math.min(slides.length, MAX_SLIDES);i++){
						slideIndex = i;
						await runSlide(i);
					}
					const startBtn2 = document.getElementById('startBtn'); if (startBtn2) startBtn2.disabled = false;
					if (nextBtn) nextBtn.style.display = 'none';
					alert('Quiz complete.');
				}

				// removed join button, simulate controls, and host/next buttons for player view
				// clicking a choice now prompts for a name (if not set) and submits the answer

				// storage listener so multiple tabs/devices on same browser can update
				window.addEventListener('storage', (e)=>{
					if (!e.key) return;
					if (e.key === answersKey(slideIndex) || e.key === `players_answered_${token}_${slideIndex}`) renderPlayersAnswers();
					if (e.key === scoresKey()) renderLeaderboard();
				});

				function renderPlayersAnswers() {
					const answers = loadAnswers(slideIndex);
					const reveal = document.getElementById('reveal'); if (!reveal) return;
					const names = Object.keys(answers);
					if (names.length === 0) { if (!reveal.innerHTML) reveal.innerHTML = '<div class="small">No answers yet.</div>'; return; }
					reveal.innerHTML = '<div><strong>Answers submitted:</strong></div><ul style="text-align:left;margin-top:6px">' + names.map(n=>`<li>${n}: ${slides[slideIndex].choices[Number(answers[n])] || answers[n]}</li>`).join('') + '</ul>';
				}

				// initial render and auto-start immediately for player-side
				renderSlide(0);
				renderLeaderboard();
				renderPlayersAnswers();

				// auto start immediately upon opening (player side)
				setTimeout(()=>{ try { startQuiz(); } catch(e) { console.error(e); } }, 120);

			} catch (err) {
				console.error('Slide init error', err);
			}
		});
	</script>
</body>
</html>

