<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>slideHost</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .slide-question { font-size:1.4rem; margin: 1rem 0; }
    .choices { display:flex; flex-direction:column; gap:0.6rem; margin-bottom:0.8rem; }
    .choice { padding:0.8rem; border-radius:0.6rem; background:#0f1025; border:1px solid rgba(255,255,255,0.03); }
    .meta { display:flex; justify-content:space-between; align-items:center; gap:12px; }
    #timer { font-weight:700; }
    #reveal { margin-top:0.8rem; }
    #leaderboard { text-align:left; margin-top:0.8rem; }
    .controls { margin-top:10px; }
  </style>
</head>
<body>
  <div class="card" style="max-width:900px;">
    <div class="logo">Quiz Whiz</div>
    <h1>Host Slide</h1>

    <div class="meta">
      <div>Code: <span id="token">—</span></div>
      <div>Slide <span id="currentIdx">0</span>/<span id="totalSlides">0</span></div>
      <div>Time: <span id="timer">0</span>s</div>
    </div>

    <div id="slideArea" style="margin-top:12px">
      <div class="slide-question" id="question">No slide loaded.</div>
      <div class="choices" id="choices"></div>
      <div id="reveal"></div>
    </div>

    <div id="leaderboard"></div>

    <div class="controls">
      <button id="skipBtn">Skip (Reveal)</button>
      <button id="nextBtn" style="margin-left:8px;">Next Slide</button>
    </div>
  </div>

    <script src="https://cdn.socket.io/4.8.3/socket.io.min.js"></script>
    <script>
      window.addEventListener('DOMContentLoaded', () => {
        const socket = io('http://localhost:3000');
        console.log('slideHost.html loaded, connecting socket');

       const roomCode = sessionStorage.getItem('roomCode');
       const userId = sessionStorage.getItem('userId');

       let timerInterval = null;

       document.getElementById('token').textContent = roomCode || '—';
       console.log('Room code:', roomCode, 'User ID:', userId);

       socket.on('connect', () => {
         console.log('Socket connected in slideHost.html, socket.id:', socket.id);
         if (roomCode && userId) {
           console.log('Emitting rejoin_room:', { roomCode, userId });
           socket.emit('rejoin_room', { roomCode, userId });
         }
       });

       socket.on('new_question', (data) => {
         console.log('Received new_question:', data);
         console.log('Question text:', data.question.Question);
         document.getElementById('currentIdx').textContent = data.questionIndex + 1;
         document.getElementById('question').textContent = data.question.Question;
         const choicesEl = document.getElementById('choices');
         choicesEl.innerHTML = '';
         data.question.Choices.forEach((choice) => {
           const d = document.createElement('div');
           d.className = 'choice';
           d.textContent = choice;
           choicesEl.appendChild(d);
         });
         document.getElementById('reveal').innerHTML = '';
         startTimer(data.timeLimit);
       });

       socket.on('reveal_answers', (data) => {
         console.log('Received reveal_answers:', data);
         clearInterval(timerInterval);
         document.getElementById('timer').textContent = '0';
         let revealText = `<div>Correct answer: <strong>${data.correctAnswer}</strong></div>`;
         if (data.correctNames.length > 0) {
           revealText += `<div style="margin-top:6px">Correct: ${data.correctNames.join(', ')}</div>`;
         }
         document.getElementById('reveal').innerHTML = revealText;
       });

       socket.on('leaderboard_update', (data) => {
         console.log('Received leaderboard_update:', data);
         const leaderboard = data.leaderboard;
         const el = document.getElementById('leaderboard');
         if (leaderboard.length === 0) {
           el.innerHTML = '<div style="color:var(--muted)">No scores yet.</div>';
           return;
         }
         el.innerHTML = '<strong>Leaderboard</strong><ol>' + leaderboard.map(([name, score]) => `<li>${name} — ${score}</li>`).join('') + '</ol>';
       });

       function startTimer(sec) {
         let t = sec;
         document.getElementById('timer').textContent = t;
         timerInterval && clearInterval(timerInterval);
         timerInterval = setInterval(() => {
           t -= 1;
           document.getElementById('timer').textContent = t;
           if (t <= 0) {
             clearInterval(timerInterval);
             timerInterval = null;
           }
         }, 1000);
       }

       // Host controls: for now, just watch
       // Could add skip/next but backend auto-handles
     });
   </script>
</body>
</html>
